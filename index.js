"use strict";function getImgDir(e,t){var n=e.get("referer").split("/articles/")[1].split("/");return n.pop(),path.join(ARTICLE_SRC,n.join("/"),t)}function crc32(e){var t=function(){for(var e=0,t=new Array(256),n=0;256!=n;++n)e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=n)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1,t[n]=e;return"undefined"!=typeof Int32Array?new Int32Array(t):t}(),n=e+"?r="+Math.random().toString(10).substring(2),r=function(e){for(var n,r,o=-1,i=0,s=e.length;i<s;)(n=e.charCodeAt(i++))<128?o=o>>>8^t[255&(o^n)]:n<2048?(o=o>>>8^t[255&(o^(192|n>>6&31))],o=o>>>8^t[255&(o^(128|63&n))]):n>=55296&&n<57344?(n=64+(1023&n),r=1023&e.charCodeAt(i++),o=o>>>8^t[255&(o^(240|n>>8&7))],o=o>>>8^t[255&(o^(128|n>>2&63))],o=o>>>8^t[255&(o^(128|r>>6&15|(3&n)<<4))],o=o>>>8^t[255&(o^(128|63&r))]):(o=o>>>8^t[255&(o^(224|n>>12&15))],o=o>>>8^t[255&(o^(128|n>>6&63))],o=o>>>8^t[255&(o^(128|63&n))]);return-1^o}(n)>>>0;return n+"&s="+r}function getTudouVideo(e,t){fetch(TODOU_URL.replace(/\{vid\}/g,e)).then(function(e){return e.json()}).then(function(e){return t.redirect(e.data.stream[0].m3u8_url)}).catch(function(e){return t.send(e.toString())})}function getTudouPoster(e,t){fetch(TODOU_URL.replace(/\{vid\}/g,e)).then(function(e){return e.json()}).then(function(e){return t.redirect(e.data.video.logo)}).catch(function(e){return t.send(e.toString())})}var express=require("express"),app=express(),bodyParser=require("body-parser"),path=require("path"),fs=require("fs"),fetch=require("node-fetch"),request=require("request"),iconv=require("iconv-lite"),cheerio=require("cheerio"),config=require("./config"),ARTICLE_SRC=config.ARTICLE_SRC;"function"==typeof ARTICLE_SRC&&(ARTICLE_SRC=ARTICLE_SRC());var ARTICLE_DIST=config.ARTICLE_DIST,INJECT_CODE='\n\x3c!-- START EDITOR INJECT CODE --\x3e\n<link rel="stylesheet" href="/fontello/css/fontello.css">\n<link rel="stylesheet" href="/sweetalert.css">\n<link rel="stylesheet" href="/editor.css?{ts}">\n<script src="/exif.js"><\/script>\n<script src="/sweetalert.min.js"><\/script>\n<script>\nvar MAX_UPLOAD_PICS='+config.MAX_UPLOAD_PICS+";\nvar ORIGIN_ARTICLE_PATH = '"+config.ORIGIN_ARTICLE_PATH+'\';\n<\/script>\n<script src="/editor.js?{ts}"><\/script>\n\x3c!-- END EDITOR INJECT CODE --\x3e',STATIC_PATH=__dirname+"/public",PORT=process.env.PORT||3e3;app.use(bodyParser.json({limit:"5mb"})),app.use(bodyParser.urlencoded({extended:!0,limit:"5mb"})),app.get(/^\/articles\/(.+?\.html)$/,function(e,t,n){var r=e.params[0];r||t.status(404).end("Page not Found!");var o=path.join(ARTICLE_SRC,r);return r.indexOf("____.html")>-1?fs.readdir(ARTICLE_SRC+(e.query.p||""),function(e,n){return t.send(n)}):fs.existsSync(o)?void fs.readFile(o,function(n,r){if(n)return t.status(500).end(n.toString());var o=INJECT_CODE.replace(/\{ts\}/g,Date.now());void 0!==e.query.test&&(o=o.replace(/editor\./g,"dist/editor.")),-1!==r.toString().indexOf("�")&&(r=iconv.decode(r,"GBK"),r=iconv.encode(r,"UTF8"),o+="\x3c!-- ENCODE:GBK --\x3e");var i=!1;r=r.toString().replace(/<\/body>/i,function(e){return i=!0,o+e}),i||(r+=o+"</body></html>"),t.send(r)}):n()}),app.post("/upload",function(e,t){var n=e.body.data||"";if(!n)return t.json({code:-1,msg:"参数错误"});var r="png",o=n.replace(/^data:image\/(\w+);base64,/,function(e,t){return r=t,""}),i=Date.now()+(""+Math.random()).substr(1)+"."+r;fs.writeFile(getImgDir(e,i),new Buffer(o,"base64"),function(e){e?t.json({code:-1,msg:e.toString()}):t.json({code:0,msg:i})})}),app.post("/delimg",function(e,t){var n=e.body.img;n&&n.split("|").forEach(function(t){t=getImgDir(e,t),fs.existsSync(t)&&fs.unlink(t)}),t.json({code:0,msg:"删除成功"})}),app.post("/save",function(e,t){var n=e.body.content,r=e.body.title,o=e.body.page;if(n&&o){var i=path.join(ARTICLE_SRC,o.replace(/^\/articles/,""));if(!fs.existsSync(i))return t.send({code:-1,msg:"原始文件不存在"});fs.readFile(i,function(e,o){if(e)return t.status(500).end(e.toString());var s=-1!=o.toString().indexOf("�");s&&(o=iconv.decode(o,"GBK"),o=iconv.encode(o,"UTF8"));var u=cheerio.load(o.toString());u(".n_title").html(r),u("title").html(r),u(".n_content").html(n).css("word-break","break-all"),o=u.html(),s&&(o=iconv.encode(o,"GBK"));var c=ARTICLE_DIST;"function"==typeof ARTICLE_DIST&&(c=ARTICLE_DIST(i)),fs.writeFile(c,o,function(){t.json({code:0,msg:"ok"})})})}else t.json({code:-1,msg:"参数缺失"})});var TODOU_URL="https://ups.youku.com/ups/get.json?vid={vid}&ccode=0505&client_ip=0.0.0.0&client_ts=1491234773&utid=ACXYEMfZ%2BUACAXT3bTq%2BRp%2Fq";app.get("/tudou-video-url",function(e,t){return/\d{9}/.test(e.query.vid)?fetch("http://video.tudou.com/v/"+e.query.vid).then(function(e){return e.text()}).then(function(e){return/viden: "([\w=]+==)"/.test(e)&&getTudouVideo(RegExp.$1,t)}):getTudouVideo(e.query.vid,t)}),app.get("/tudou-video-poster",function(e,t){return/\d{9}/.test(e.query.vid)?fetch("http://video.tudou.com/v/"+e.query.vid).then(function(e){return e.text()}).then(function(e){return/viden: "([\w=]+==)"/.test(e)&&getTudouPoster(RegExp.$1,t)}):getTudouPoster(e.query.vid,t)});var TOUTIAO_OPTS={headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 9_1 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13B143 Safari/601.1"}};app.get("/toutiao-video-url",function(e,t){var n=e.query.url,r=e.headers;delete r.referer,delete r.host,fetch(n,TOUTIAO_OPTS).then(function(e){return e.text()}).then(function(e){if(/item_id = "(\d+)"/.test(e))return fetch("https://m.365yg.com/i"+RegExp.$1+"/info/");throw new Error("无法解析")}).then(function(e){return e.json()}).then(function(e){var t=/tt-videoid='([^']+)'/.test(e.data.content)&&RegExp.$1;return fetch("http://i.snssdk.com"+crc32("/video/urls/v/1/toutiao/mp4/"+t))}).then(function(e){return e.json()}).then(function(e){return new Buffer(e.data.video_list.video_1.main_url,"base64").toString()}).then(function(e){return request({url:e,headers:r}).pipe(t)}).catch(function(e){return t.send(e.toString())})}),app.get("/toutiao-video-poster",function(e,t){fetch(e.query.url,TOUTIAO_OPTS).then(function(e){return e.text()}).then(function(e){if(/share_url:'http:\/\/www\.toutiao\.com\/item\/(\d+)\/'/.test(e)||/item_id = "(\d+)"/.test(e))return fetch("https://m.365yg.com/i"+RegExp.$1+"/info/");throw new Error("无法解析")}).then(function(e){return e.json()}).then(function(e){var t=/tt-poster='([^']+)'/.test(e.data.content)&&RegExp.$1;return fetch(t)}).then(function(e){return e.body.pipe(t)}).catch(function(e){return t.send("")})}),app.use("/articles",express.static(ARTICLE_SRC)),app.use(express.static(STATIC_PATH)),config.ORIGIN_ARTICLE_PATH&&app.all("*",function(e,t,n){var r=e.params[0];r=0===r.indexOf("/articles")?r.replace(/^\/articles/,""):".."+r;var o={method:e.method,url:config.ORIGIN_ARTICLE_PATH+r,qs:e.query,json:!0,body:e.body,headers:e.headers};request(o,function(e,r,o){if(e)return n(e);t.set(r.headers),t.send(o)})}),app.listen(PORT,function(){console.log("Example app listening on port "+PORT+"!")});